<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>버스 대기자 관리</title>
<style>
body { font-family: sans-serif; text-align: center; }
button { margin: 5px; padding: 10px; }
#info { margin-top: 10px; }
</style>
</head>
<body>

<div id="stationInput">
  <h2>정류장 번호 입력</h2>
  <input type="text" id="stationIdInput" placeholder="정류장 번호">
  <button onclick="getStation()">확인</button>
</div>

<div id="busSection" style="display:none;">
  <h2 id="stationName"></h2>
  <div id="busButtons"></div>
  <button onclick="tagUser()">대기자 등록</button>
  <button onclick="extendTime()">유효시간 연장</button>

  <div id="info">
    <p>현재 대기자수: <span id="count">-</span>명</p>
    <p>전 정류장 대기자수: <span id="previous">-</span>명</p>
    <p id="result"></p>
  </div>
</div>

<script>
let selectedBus = null;
let stationId = null;
let userId = "testuser";

function getStation() {
  stationId = document.getElementById("stationIdInput").value;
  fetch("/api/get_station", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({station_id: stationId})
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert("정류장 없음!");
      return;
    }
    document.getElementById("stationName").innerText = data.name;
    document.getElementById("busButtons").innerHTML = "";
    data.buses.forEach(bus => {
      const btn = document.createElement("button");
      btn.innerText = bus;
      btn.onclick = () => { selectedBus = bus; updateStatus(); };
      document.getElementById("busButtons").appendChild(btn);
    });
    document.getElementById("stationInput").style.display = "none";
    document.getElementById("busSection").style.display = "block";
  });
}

function updateStatus() {
  if (!selectedBus) return;
  fetch("/api/status", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({station_id: stationId, bus_no: selectedBus})
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("count").innerText = data.count;
  });
}

function tagUser() {
  if (!selectedBus) return;
  fetch("/api/tag", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({station_id: stationId, bus_no: selectedBus, user_id: userId})
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("result").innerText = `${data.message} (순번: ${data.position})`;
    document.getElementById("previous").innerText = data.previous_count;
    updateStatus();
  });
}

function extendTime() {
  if (!selectedBus) return;
  fetch("/api/extend", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({station_id: stationId, bus_no: selectedBus, user_id: userId})
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("result").innerText = data.message;
    updateStatus();
  });
}

setInterval(updateStatus, 5000);
</script>

</body>
</html>
